name: Frontend CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch: {}

permissions:
    contents: read

concurrency:
    group: frontend-ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build-test:
        name: Build & test (Vite/React)
        runs-on: ubuntu-latest
        timeout-minutes: 15
        env:
            CI: true

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm

            - name: Install deps
              run: npm ci

            - name: Lint
              run: |
                  if npm run -s | grep -q "^  lint"; then
                    npm run lint -- --format github
                  else
                    echo "No lint script – skipping"
                  fi

            - name: Typecheck
              run: |
                  if npm run -s | grep -q "^  typecheck"; then
                    npm run typecheck
                  else
                    npx tsc --noEmit
                  fi

            - name: Tests (Vitest)
              run: |
                  if npm run -s | grep -q "^  test"; then
                    npm run test
                  else
                    echo "No test script – skipping"
                  fi

            - name: Changelog Check
              run: |
                  if npm run -s | grep -q "changelog:check"; then
                    npm run changelog:check || (echo "\nChangelog check failed." && exit 1)
                  else
                    echo "No changelog:check script – skipping"
                  fi

            - name: Build
              run: npm run build

            - name: Upload build artifact (dist/)
              uses: actions/upload-artifact@v5
              with:
                  name: web-dist
                  path: dist
                  if-no-files-found: ignore
                  retention-days: 7

            - name: Upload coverage (if generated)
              uses: actions/upload-artifact@v5
              with:
                  name: coverage
                  path: |
                      coverage
                      coverage/**/*
                  if-no-files-found: ignore
                  retention-days: 7
        #     - name: web-dist
        #       path: dist
        #
        #     - name: Install Netlify CLI
        #       run: npm i -g netlify-cli
        #
        #     - name: Deploy preview (PR) or prod (manual on main)
        #       env:
        #         NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        #         NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        #       run: |
        #         if [ "${{ github.event_name }}" = "pull_request" ]; then
        #           netlify deploy \
        #             --dir=dist \
        #             --site="$NETLIFY_SITE_ID" \
        #             --auth="$NETLIFY_AUTH_TOKEN" \
        #             --message "PR #${{ github.event.pull_request.number }}" \
        #             --draft --json
        #         else
        #           netlify deploy \
        #             --dir=dist \
        #             --site="$NETLIFY_SITE_ID" \
        #             --auth="$NETLIFY_AUTH_TOKEN" \
        #             --prod --message "manual main" --json
